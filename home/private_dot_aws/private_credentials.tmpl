{{- if eq .aws.credentials_source "1password" -}}
{{-   $account_vaults := (includeTemplate "1password_vaults.tmpl" . | fromJson) -}}
{{-   range $account, $vaults := $account_vaults -}}
{{-     $documents := (output "op" "document" "list" "--account" $account "--format" "json" | fromJson) -}}
{{-     $documents = $documents | jq "map(select(.title | startswith(\"aws-credentials:\"))) | sort_by(.title)" -}}
{{-     $documents = index $documents 0 -}}
{{-     range $document := $documents -}}
{{-       $vault_name := (get $vaults $document.vault.id).name }}
{{        printf "# %v (from 1password %v %v)" $document.title $account $vault_name }}

{{        onepasswordDocument $document.id $document.vault.id $account }}
{{-    end -}}
{{-   end -}}
{{- end -}}
